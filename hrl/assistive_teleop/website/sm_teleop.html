<html>
<head>
  <title>Teleop Trial</title>
    
    <link type="text/css" href="jqueryui/css/sunny/jquery-ui-1.8.10.custom.css" rel="stylesheet" />   
    <script type="text/javascript" src="jqueryui/js/jquery-1.4.4.min.js"></script> 
    <script type="text/javascript" src="jqueryui/js/jquery-ui-1.8.10.custom.min.js"></script> 
    <script type="text/javascript" src="json2.js"></script>
    <!--<script type="text/javascript" src="rosexp.min.js"></script>-->
    <script type="text/javascript" src="rosbridge.min.js"></script>
    <script type="text/javascript" src="ros/ros.js"> </script>

<script type="text/javascript">
function nop(){};
function json(obj){return JSON.stringify(obj);};
function log(message){ document.getElementById('console').innerHTML = message.toString();  };

//var robot = 'monty1.hsi.gatech.edu';
var robot = '10.68.0.1';
var head_pub;
var base_pub;
var h_scale=b_scale=rarm_scale=larm_scale=rwrist_scale=lwrist_scale=50;
var bx=by=bz=tz=rgp=lgp=count_surf_wipe_right=count_surf_wipe_left=force_wipe_count=0;
var rarm_joints = [];
var img_act = 'looking'
var norm_appr_left = norm_appr_right = driving = tool_state = false;
arm = function(){ return $('input[name=arm_sel]:radio:checked').val()};
var plane = 'xy';

$(function(){
	$('#slider').slider({value:50,min:0,max:100,step:1,orientation:'vertical'}); 
	$('#force_view').slider({value:0,range:'min',min:0,max:15,step:0.05,orientation:'vertical'}); 
	$('#force_set').slider({value:1,min:0,max:15,step:0.05,orientation:'vertical'}); 
	$('#force_set').unbind("slidestop").bind("slidestop", function(event,ui){pub_ft_goal($('#force_set').slider('value')); log('Setting Force Threshold to '+ $('#force_set').slider("value").toString() + ' N ('+0.01*Math.round(100*($('#force_set').slider("value")/4.44822)).toString()+' lbf)')});	
	$('#rg_slider').slider({min:0,max:0.09,step:0.001,orientation:'vertical'}); 
	$('#rg_slider').unbind("slidestop").bind("slidestop", function(event,ui){rgp=$('#rg_slider').slider("value"); pub_gripper('r',rgp); log('Opening/Closing Right Gripper'); });	
	$('#lg_slider').slider({min:0,max:0.09,step:0.001,orientation:'vertical'}); 
	$('#lg_slider').unbind("slidestop").bind("slidestop", function(event,ui){lgp=$('#lg_slider').slider("value"); pub_gripper('l',lgp); log("Opening/Closing Left Gripper"); });	
	$('#torso_slider').slider({min:0.005,max:0.3,step:0.01,orientation:'vertical'});
	$('#torso_slider').unbind("slidestop").bind("slidestop", function(event,ui){tz=$('#torso_slider').slider("value"); pub_spine(); log("Raising/Lowering Spine"); });	
	$('#submit_text').click(function(e){speak($('#txt2say').val())});
	$("body").find('*').mouseup(function(e){window.bx=0; window.by=0; window.bz=0});
	$('#slelect_plane').change(function(event,ui){window.plane = $('#select_plane').val()});
	$('.cont_sel').click(function(e){$('.cont_sel').css('background-color','buttonface'); $(this).css('background-color', 'gray') }); 
    $('.shave_acts').hide();
	$('#reset, #bpd2, #shave_end, #shave_select, #shave').hide(); 
});

function init (){
    log("Beginning Initialization");
	if (!window.point_2d){
        log("Looking for Pixel_2_3d service");
		node.rosjs.callService('/rosbridge/reqClassFromTypeString','["pixel_2_3d/Pixel23d"]', function(msg){window.point_2d = msg; init()});
//	}else if (!window.gm_ps){
       // log('pixel_2_3d Initialized, trying PoseStamped'); 
		//node.rosjs.callService('/rosbridge/msgClassFromTypeString','["geometry_msgs/PoseStamped"]', function(msg){window.gm_ps = msg; init()});
	}else if (!window.gm_point){
        log('PoseStamped Initialized, trying Geometry_msgs Point'); 
		node.rosjs.callService('/rosbridge/msgClassFromTypeString','["geometry_msgs/Point"]', function(msg){window.gm_point = msg; init()});
	}else if (!window.JTAGoal){
        log('Geometry_msgs Point Initialized, trying Joint Trajectory Action Goal');
		node.rosjs.callService('/rosbridge/msgClassFromTypeString','["pr2_controllers_msgs/JointTrajectoryActionGoal"]', function(msg){window.JTAGoal = msg; init()});
	}else {
        log('Joint Trajectory Action Goal Initialized, loading video'); 
        $('#force_view').slider("option", "disabled", true);
        set_camera("/arrow_overlaid");
	    log('Fully Initialized');
	};
};

function sub_state() {
	node.subscribe('/head_traj_controller_state_throttle',function(msg){
			window.head = msg.actual;
			window.head_joints = msg.joint_names;
			document.getElementById('head_pos_out').innerHTML='Head Position: Left/Right:\ \ ' + Math.round(-window.head.positions[0]*180/Math.PI) + '\ deg.\ \ Up/Down:' + Math.round(-window.head.positions[1]*180/Math.PI) + '\ deg.'
			});
    log('Head State Found');
	node.subscribe('/r_gripper_controller_state_throttle',function(msg){rgp=msg.process_value;$('#rg_slider').show().slider("option", "value", rgp); $('#rg_progress').progressbar("value", rgp)});
    log('Right Gripper State Found');
	node.subscribe('/l_gripper_controller_state_throttle',function(msg){lgp=msg.process_value;$('#lg_slider').show().slider("option", "value", lgp); $('#lg_progress').progressbar("value", lgp)});
    log('Left Gripper State Found');
	node.subscribe('/torso_state_throttle',function(msg){tz=msg.actual.positions[0];$('#torso_slider').show().slider("option", "value", tz)});
    log('Torso State Found');
	node.subscribe('/wt_log_out', function(msg){ log(msg.data.toString())});
    log('Listening for Feedback messages');
	
		//Move Arm Pose State
	node.subscribe('/r_arm_controller_state_throttle', function(msg){window.rarm_joints = msg.actual});
	node.subscribe('/l_arm_controller_state_throttle', function(msg){window.larm_joints = msg.actual});
	node.subscribe('/wt_force_out_throttle', function(ws){$('#force_view').slider("option", "value",
                    Math.sqrt(Math.pow(ws.wrench.force.x,2) + Math.pow(ws.wrench.force.y,2) + Math.pow(ws.wrench.force.z,2)))});
	node.subscribe('/ros_switch_state', function(msg){
                    window.tool_state=msg.data;
                        });
	node.subscribe('/sm_selected_pose', function(msg){window.sm_selected_pose = msg.data});
};

function pub_ft_goal(thresh) {
    log(thresh)
    node.publish('/wt_ft_goal', 'std_msgs/Float32', JSON.stringify({'data':thresh}))
};

function click_position(e) {
	var posx = 0;
	var posy = 0;
	if (!e) var e = window.event;
	if (e.pageX || e.pageY) 	{
		posx = e.pageX;
		posy = e.pageY;
	}
	else if (e.clientX || e.clientY) 	{
		posx = e.clientX + document.body.scrollLeft
			+ document.documentElement.scrollLeft;
		posy = e.clientY + document.body.scrollTop
			+ document.documentElement.scrollTop;
	}	return [posx,posy]
};

function get_im_3d(x,y){
	window.point_2d.pixel_u = x;
	window.point_2d.pixel_v = y;
    log('Sending Pixel_2_3d request, awaiting response');
	node.rosjs.callService('/pixel_2_3d','['+JSON.stringify(window.point_2d.pixel_u)+','+JSON.stringify(window.point_2d.pixel_v)+']', function(msg){
		log('pixel_2_3d response received');
		point_3d=msg.pixel3d;
        /*if (window.img_act == 'driving'){
            log('Attempting to Drive to goal location')
            pub_head_goal(0.8, 0.0, -0.25, '/base_footprint');
            node.publish('/servo_goal', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d.pixel3d));
        }*/
        if (window.img_act == 'looking') {
                log("Sending look to point command");
                window.head_pub = window.clearInterval(head_pub);
                pub_head_goal(point_3d.pose.position.x, point_3d.pose.position.y, point_3d.pose.position.z, point_3d.header.frame_id);
        } else if (window.img_act == 'head_nav_goal') {
                log("Sending navigation seed position");
                node.publish('/head_nav_goal', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d));
        } else if (window.img_act == 'init_head_cloud') {
                log("Sending Initial Position for Head Model");
                node.publish('/init_head', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d));
        };
        if (window.arm() =='l') {
            if(window.img_act == 'norm_approach'){
                log('Sending Left Arm Normal Approach Command')
                node.publish('norm_approach_left', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d));
            } else if (window.img_act == 'grasp'){
                log('Sending command to attempt to grasp object with left arm')
                node.publish('/wt_grasp_left_goal', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d));
            } else if (window.img_act == 'reactive_grasp'){
                log('Sending command to grasp object with reactive grasping with left arm');
                node.publish('/reactive_grasp_left', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d));
            } else if (window.img_act == 'wipe'){
                node.publish('/wt_wipe_left_goals', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d));
                if (window.force_wipe_count == 0) {
                    window.force_wipe_count = 1;
                    log('Sending start position for force-sensitive wiping')
                } else if (window.force_wipe_count == 1) {
                    window.force_wipe_count = 0;
                    log('Sending end position for force-sensitive wiping')
                };    
            } else if (window.img_act == 'swipe'){
                log('Sending command to swipe from start to finish with left arm')
                node.publish('/wt_swipe_left_goals', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d));
            } else if (window.img_act == 'hfc_swipe'){
                log('Sending command to swipe from start to finish with left arm using Force Controller')
                node.publish('/wt_hfc_swipe_left_goals', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d));
            } else if (window.img_act == 'poke'){
                log('Sending command to poke point with left arm')
                node.publish('/wt_poke_left_point', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d));
            } else if (window.img_act == 'contact_approach'){
                log('Sending command to approaching point by moving until contact with left arm')
                node.publish('/wt_contact_approach_left', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d));
            } else if (window.img_act == 'hfc_contact_approach'){
                log('Sending command to approach point by moving until contact using Force Controller with left arm')
                node.publish('/wt_hfc_contact_approach_left', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d));
            };
        } else if (window.arm() =='r') {
            if(window.img_act == 'norm_approach'){
                log('Sendinging Right Arm Normal Approach Command')
                node.publish('norm_approach_right', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d));
            } else if (window.img_act == 'grasp'){
                log('Sending command to grasp object with Right arm')
                node.publish('/wt_grasp_right_goal', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d));
            } else if (window.img_act == 'reactive_grasp'){
                log('Sending command to grasp object with reactive grasping using right arm');
                node.publish('/reactive_grasp_right', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d));
            } else if (window.img_act == 'wipe'){
                log('Sending command to Wipe between points with right arm')
                node.publish('/wt_wipe_right_goals', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d));
            } else if (window.img_act == 'swipe'){
                log('Sending command to swipe from start to finish with right arm')
                node.publish('/wt_swipe_right_goals', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d));
            } else if (window.img_act == 'poke'){
                log('Sending command to poking point with right arm')
                node.publish('/wt_poke_right_point', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d));
            };
        };
        if (window.force_wipe_count == 0){
            $('#img_act_select').val('looking');  window.img_act = 'looking';
        };
	})
};

function get_point(event){
	var point = click_position(event);
	click_x = point[0] - document.getElementById('video_container').offsetLeft 
	click_y = point[1] - document.getElementById('video_container').offsetTop 

	log("Clicked on point (x,y) = ("+ click_x.toString() +","+ click_y.toString()+")");
	return [click_x, click_y]
};

function image_click(event){
	var im_pixel = get_point(event);
	if (window.img_act == 'surf_wipe') {
    surf_points_out = window.gm_point
    surf_points_out.x = im_pixel[0]
    surf_points_out.y = im_pixel[1]
    log('Surface Wipe');
    if (window.arm() == 'r') {	
        log('Surface Wipe Right'+window.count_surf_wipe_right.toString())
        node.publish('wt_surf_wipe_right_points', 'geometry_msgs/Point', JSON.stringify(surf_points_out));
        if (window.count_surf_wipe_right == 0){
           log("Sending start position for surface-aware wiping with right arm");
           window.count_surf_wipe_right = 1;
        } else if (window.count_surf_wipe_right == 1){
           log("Sending end position for surface-aware wiping with right arm");
           window.count_surf_wipe_right = 0;
           $('#img_act_select').val('looking');  window.img_act = 'looking';
        }
    } else if (window.arm() == 'l') {
        node.publish('wt_surf_wipe_left_points', 'geometry_msgs/Point', JSON.stringify(surf_points_out));
        if (window.count_surf_wipe_left == 0){
           log("Sending start position for surface-aware wiping with left arm");
           window.count_surf_wipe_left = 1;
        } else if (window.count_surf_wipe_left == 1){
           log("Sending end position for surface-aware wiping with left arm");
           window.count_surf_wipe_left = 0;
           $('#img_act_select').val('looking');  window.img_act = 'looking';
        }
    };
    }else{
	get_im_3d(im_pixel[0],im_pixel[1])
	};
};

function pub_lin_move(arm){
	if (arm == 'r'){
		node.publish('wt_lin_move_right','std_msgs/Float32', JSON.stringify({"data":window.lin_move_right}));
		log('Sending Right Hand Advance/Retreat command');
	} else {
		node.publish('wt_lin_move_left','std_msgs/Float32', JSON.stringify({"data":window.lin_move_left}));
		log('Sending Left Hand Advance/Retreat Command');
	};
};

function pub_arm_joints(angles, arm){
	angles.velocities = [];
	if (arm == 'r'){
		node.publish('wt_right_arm_angle_commands', 'trajectory_msgs/JointTrajectoryPoint', JSON.stringify(rarm_joints))
	}else{
		node.publish('wt_left_arm_angle_commands', 'trajectory_msgs/JointTrajectoryPoint', JSON.stringify(larm_joints))
	}	
};

function control_arm(x,y,z,arm){
	goal = window.gm_point;
    goal.x = x;
    goal.y = y;
    goal.z = z;
    if (arm == 'r'){
		log('Sending command to right arm');
		node.publish('wt_right_arm_pose_commands', 'geometry_msgs/Point', JSON.stringify(goal));
	}else{
		log('Sending command to left arm');
		node.publish('wt_left_arm_pose_commands', 'geometry_msgs/Point', JSON.stringify(goal));
	};
};

function pub_gripper(arm,grpos) {
	node.publish(arm + '_gripper_controller/gripper_action/goal', 'pr2_controllers_msgs/Pr2GripperCommandActionGoal', JSON.stringify(
		{    'goal':{'command':{'position': grpos ,'max_effort':-1}}}));
};

function teleop_arm(arm) {
	var x,y,z,b9txt,b7txt;
	if (plane == 'xy'){x=0; y=1; z=2; b9txt='Up'; b7txt='Down'}
	else if (plane == 'yz') {x=2; y=1; z=0; b9txt='Further Away'; b7txt='Closer'};

	if (arm=='r') {	
		log("Controlling Right Arm");
		$('#slider').unbind("slidestop");
		$('#slider').bind("slidestop", function(event,ui){rarm_scale = $('#slider').slider("value")});
		$('#slider').show().slider("option", "value", rarm_scale);

		$("#tp").unbind().show();
		$("#tp").click(function(e){
			y = -(e.pageX - Math.round(this.width/2) - this.x)/500;
			x = -(e.pageY - Math.round(this.height/2) - this.y)/500;
			control_arm(x,y,0,'r');	
		});

		$('.bpd').unbind();
		$('#b9').show().text(b9txt).click(function(e){//arm up vertically
			control_arm(0,0,rarm_scale/500,'r');
		});
		$('#b8').show().text("^").click(function(e){//arm forward horizantally 
			control_arm(rarm_scale/500,0,0,'r');
		});
		$('#b7').show().text(b7txt).click(function(e){//arm down vertically
			control_arm(0,0,-rarm_scale/500,'r');
		});
		$('#b6').show().text(">").click(function(e){ // arm right horizantally 
			control_arm(0,-rarm_scale/500,0,'r');
		});
		$('#b5').hide()
		$('#b4').show().text("<").click(function(e){ //arm left horizantally
			control_arm(0,rarm_scale/500,0,'r');
		});
		$('#b3').show().text("Advance").click(function(e){window.lin_move_right=0.1*(rarm_scale/100); pub_lin_move('r');});
		$('#b2').show().text("v").click(function(e){ //arm backward horizantally
			control_arm(-rarm_scale/500,0,0,'r');
		});
		$('#b1').show().text("Retreat").click(function(e){window.lin_move_right=-0.1*(rarm_scale/100); pub_lin_move('r');});
	} else {
		log("Controlling Left Arm");
		$('#slider').unbind("slidestop");
		$('#slider').bind("slidestop", function(event,ui){larm_scale = $('#slider').slider("value")});
		$('#slider').show().slider("option", "value", larm_scale);
		
		$("#tp").unbind().show();
		$("#tp").click(function(e){
			y = -(e.pageX - Math.round(this.width/2) - this.x)/500;
			x = -(e.pageY - Math.round(this.height/2) - this.y)/500;
			control_arm(x,y,0,'l');	
		});

		$('.bpd').unbind();
		$('#b9').show().text("Up").click(function(e){//arm up vertically
			control_arm(0,0,larm_scale/500,'l');
		});
		$('#b8').show().text("^").click(function(e){//arm forward horizantally 
			control_arm(larm_scale/500,0,0,'l');
		});
		$('#b7').show().text("Down").click(function(e){//arm down vertically
			control_arm(0,0,-larm_scale/500,'l');
		});
		$('#b6').show().text(">").click(function(e){ // arm right horizantally 
			control_arm(0,-larm_scale/500,0,'l');
		});
		$('#b5').hide()
		$('#b4').show().text("<").click(function(e){ //arm left horizantally
			control_arm(0,larm_scale/500,0,'l');
		});
		$('#b3').show().text("Advance").click(function(e){window.lin_move_left=0.1*(larm_scale/100); pub_lin_move('l');});
		$('#b2').show().text("v").click(function(e){ //arm backward horizantally
			control_arm(-larm_scale/500,0,0,'l');
		});
		$('#b1').show().text("Retreat").click(function(e){window.lin_move_left=-0.1*(larm_scale/100); pub_lin_move('l');});
	};
};

function pub_elbow(elbow_arm, dir) {
    var action = 'Raise '
    if (dir == -1) { action = 'Lower ' };
    if (elbow_arm == 'right') {
        node.publish('wt_adjust_elbow_right','std_msgs/Float32', JSON.stringify({"data":dir}));
    } else {
        node.publish('wt_adjust_elbow_left','std_msgs/Float32', JSON.stringify({"data":dir}));
    };
    log('Sending command to ' + action + elbow_arm + ' elbow')
};

function teleop_wrist(arm) {
	if (arm=='r') {	
		log("Controlling Right Hand");
		$('#slider').unbind("slidestop");
		$('#slider').bind("slidestop", function(event,ui){rwrist_scale = $('#slider').slider("value")});
		$('#slider').show().slider("option", "value", rwrist_scale);
		$('.bpd').unbind();
	
		$("#tp").unbind().show();
		$("#tp").click(function(e){
			x = (e.pageX - Math.round(this.width/2) - this.x);
			y = (e.pageY - Math.round(this.height/2) - this.y);
			rarm_joint_goals = rarm_joints;
			rarm_joint_goals.positions[4] += x*0.0107;
			rarm_joint_goals.positions[5] -= y*(Math.PI/200);
			pub_arm_joints(rarm_joint_goals,'r')
		});

		$('#b9').show().text("Hand Roll Right").click(function(e){
			rarm_joint_goals = rarm_joints;
			rarm_joint_goals.positions[6] += rwrist_scale*(Math.PI/200);
			pub_arm_joints(rarm_joint_goals,'r')
		});
		$('#b8').show().text("Wrist Flex Out").click(function(e){
			rarm_joint_goals = rarm_joints;
			rarm_joint_goals.positions[5] += rwrist_scale*0.0107;
			pub_arm_joints(rarm_joint_goals,'r')
		});
		$('#b7').show().text("Hand Roll Left").click(function(e){
			rarm_joint_goals = rarm_joints;
			rarm_joint_goals.positions[6] -= rwrist_scale*(Math.PI/200);
			pub_arm_joints(rarm_joint_goals,'r')
		});
		$('#b6').show().text("Arm Roll Right").click(function(e){
			rarm_joint_goals = rarm_joints;
			rarm_joint_goals.positions[4] += rwrist_scale*(Math.PI/200);
			pub_arm_joints(rarm_joint_goals,'r')
		});
		$('#b5').hide()
		$('#b4').show().text("Arm Roll Left").click(function(e){
			rarm_joint_goals = rarm_joints;
			rarm_joint_goals.positions[4] -= rwrist_scale*0.0107;
			pub_arm_joints(rarm_joint_goals,'r')
		});
		$('#b3').show().text("Raise Elbow").click(function(e){
            pub_elbow('right', 1)
        });
		$('#b2').show().text("Wrist Flex In").click(function(e){ 
			rarm_joint_goals = rarm_joints;
			rarm_joint_goals.positions[5] -= rwrist_scale*(Math.PI/200);
			pub_arm_joints(rarm_joint_goals,'r')
		});
		$('#b1').show().text("Lower Elbow").click(function(e){
            pub_elbow('right', -1)
        });
	} else {
		log("Controlling Left Hand");
		$('#slider').unbind("slidestop");
		$('#slider').bind("slidestop", function(event,ui){lwrist_scale = $('#slider').slider("value")});
		$('#slider').show().slider("option", "value", lwrist_scale);
		$('.bpd').unbind();

		$("#tp").unbind().show();
		$("#tp").click(function(e){
			x = (e.pageX - Math.round(this.width/2) - this.x);
			y = (e.pageY - Math.round(this.height/2) - this.y);
			larm_joint_goals = larm_joints;
			larm_joint_goals.positions[4] += x*0.0107;
			larm_joint_goals.positions[5] -= y*(Math.PI/200);
			pub_arm_joints(larm_joint_goals,'l')
		});

		$('#b9').show().text("Hand Roll Right").click(function(e){
			larm_joint_goals = larm_joints;
			larm_joint_goals.positions[6] += lwrist_scale*(Math.PI/200);
			pub_arm_joints(larm_joint_goals,'l')
		});
		$('#b8').show().text("Wrist Flex Out").click(function(e){
			larm_joint_goals = larm_joints;
			larm_joint_goals.positions[5] += lwrist_scale*0.0107;
			pub_arm_joints(larm_joint_goals,'l')
		});
		$('#b7').show().text("Hand Roll Left").click(function(e){
			larm_joint_goals = larm_joints;
			larm_joint_goals.positions[6] -= lwrist_scale*(Math.PI/200);
			pub_arm_joints(larm_joint_goals,'l')
		});
		$('#b6').show().text("Arm Roll Right").click(function(e){
			larm_joint_goals = larm_joints;
			larm_joint_goals.positions[4] += lwrist_scale*(Math.PI/200);
			pub_arm_joints(larm_joint_goals,'l')
		});
		$('#b5').hide();
		$('#b4').show().text("Arm Roll Left").click(function(e){
			larm_joint_goals = larm_joints;
			larm_joint_goals.positions[4] -= lwrist_scale*(Math.PI/200);
			pub_arm_joints(larm_joint_goals,'l')
		});
		$('#b3').show().text("Raise Elbow").click(function(e){
            pub_elbow('left', 1)
        });
		$('#b2').show().text("Wrist Flex In").click(function(e){ //
			larm_joint_goals = larm_joints;
			larm_joint_goals.positions[5] -= lwrist_scale*0.0107;
			pub_arm_joints(larm_joint_goals,'l')
		});
		$('#b1').show().text("Lower Elbow").click(function(e){
            pub_elbow('left', -1)
        });
	};
};

function pub_spine(tz) {
	node.publish('torso_controller/position_joint_action/goal','pr2_controllers_msgs/SingleJointPositionActionGoal',json(
		{'goal':{'position': this.tz }}))
};

function pub_head_traj(head_traj_goal, dist)  {
		if (head_traj_goal.goal.trajectory.points[0].positions[0] < -2.70) {head_traj_goal.goal.trajectory.points[0].positions[0] = -2.70} 
		if (head_traj_goal.goal.trajectory.points[0].positions[0] > 2.70) {head_traj_goal.goal.trajectory.points[0].positions[0] = 2.70}
		if (head_traj_goal.goal.trajectory.points[0].positions[1] < -0.5) {head_traj_goal.goal.trajectory.points[0].positions[1] = -0.5}
		if (head_traj_goal.goal.trajectory.points[0].positions[1] > 1.4) {head_traj_goal.goal.trajectory.points[0].positions[1] = 1.4}
		head_traj_goal.goal.trajectory.joint_names = window.head_joints;
		head_traj_goal.goal.trajectory.points[0].velocities = [0, 0];
		head_traj_goal.goal.trajectory.points[0].time_from_start.secs = Math.max(4*dist, 1);
    		node.publish('head_traj_controller/joint_trajectory_action/goal', 'pr2_controllers_msgs/JointTrajectoryActionGoal', JSON.stringify(head_traj_goal));
};

function pub_head_goal(x,y,z,frame) {
	node.publish('head_traj_controller/point_head_action/goal', 'pr2_controllers_msgs/PointHeadActionGoal', json(
		{  'goal':{'target':{'header':{'frame_id':frame },
				             'point':{'x':x, 'y':y, 'z':z}},
                   'pointing_axis':{'x':1, 'y':0, 'z':0},
                   'pointing_frame':'/openni_rgb_frame',
                   'max_velocity':0.35}}))
	//log("Sending command to looking at "+x.toString() +", "+y.toString()+", "+z.toString()+" in "+frame);
};

function teleop_head() {
	window.head_pub = window.clearInterval(head_pub);
	log('Controlling Head');
	$('#slider').unbind("slidestop");
	$('#slider').bind("slidestop", function(event,ui){h_scale = $('#slider').slider("value")});
	$('#slider').show().slider("option", "value", h_scale);
	
	$("#tp").unbind().show();
	$("#tp").click(function(e){
		window.head_pub = window.clearInterval(head_pub);
		x = (e.pageX - Math.round(this.width/2) - this.x)/200;
		y = (e.pageY - Math.round(this.height/2) - this.y)/200;
   		head_traj_goal = JTAGoal;
		head_traj_goal.goal.trajectory.points[0] = window.head;
		head_traj_goal.goal.trajectory.points[0].positions[0] -= x;
		head_traj_goal.goal.trajectory.points[0].positions[1] += y;
                pub_head_traj(head_traj_goal, Math.sqrt(x*x+y*y));
	});
	
	$('.bpd').unbind();
	$('#b9').hide(); 
	$('#b8').show().text("^").click(function(e){//head up 
		window.head_pub = window.clearInterval(head_pub);
   		head_traj_goal = JTAGoal;
		head_traj_goal.goal.trajectory.points[0] = window.head;
		head_traj_goal.goal.trajectory.points[0].positions[1] -= h_scale/150;
                pub_head_traj(head_traj_goal, h_scale/150);
	});
	$('#b7').hide();
	$('#b6').show().text(">").click(function(e){ //head right
		window.head_pub = window.clearInterval(head_pub);
   		head_traj_goal = JTAGoal;
		head_traj_goal.goal.trajectory.points[0] = window.head;
		head_traj_goal.goal.trajectory.points[0].positions[0] -= h_scale/150;
                pub_head_traj(head_traj_goal, h_scale/150);
	});
	$('#b5').show().text("_|_").click(function(e){ //center head to (0,0)
		window.head_pub = window.clearInterval(head_pub);
        pub_head_goal(0.8, 0.0, -0.25, '/base_footprint');
   		//head_traj_goal = JTAGoal;
		//head_traj_goal.goal.trajectory.points[0] = window.head;
		//head_traj_goal.goal.trajectory.points[0].positions = [0,0];
                //pub_head_traj(head_traj_goal);
	});
	$('#b4').show().text("<").click(function(e){ //head left
		window.head_pub = window.clearInterval(head_pub);
   		head_traj_goal = JTAGoal;
		head_traj_goal.goal.trajectory.points[0] = window.head;
		head_traj_goal.goal.trajectory.points[0].positions[0] += h_scale/150;
                pub_head_traj(head_traj_goal, h_scale/150);
	});
	$('#b3').show().text("Track Right Hand").click(function(e){
		window.head_pub = window.clearInterval(head_pub);
		window.head_pub = window.setInterval("pub_head_goal(0,0,0,'r_gripper_tool_frame');",200);
	});	
  	$('#b2').show().text("v").click(function(e){ //head down
		window.head_pub = window.clearInterval(head_pub);
   		head_traj_goal = JTAGoal;
		head_traj_goal.goal.trajectory.points[0] = window.head;
		head_traj_goal.goal.trajectory.points[0].positions[1] += h_scale/150;
                pub_head_traj(head_traj_goal, h_scale/150);
	});
	$('#b1').show().text("Track Left Hand").click(function(e){
		window.head_pub = window.clearInterval(head_pub);
		window.head_pub = window.setInterval("pub_head_goal(0,0,0,'l_gripper_tool_frame');",200);
	});
};

function pub_Twist(bx,by,bz) {
          node.publish('/base_controller/command', 'geometry_msgs/Twist', '{"linear":{"x":' + bx + ',"y":' + by + ',"z":0}, "angular":{"x":0,"y":0,"z":' + bz + '}}');
};

function teleop_base() {
	window.base_pub = window.clearInterval(base_pub);
	window.base_pub = setInterval("pub_Twist(window.bx,window.by,window.bz)", 150);
	log("Controlling Base");
	$('#slider').unbind("slidestop");
	$('#slider').bind("slidestop", function(event,ui){b_scale = $('#slider').slider("value")});
	$('#slider').show().slider("option", "value", b_scale);
	
	$("#tp").unbind().hide();
/*// Control Mappings for the touchpad for moving the base: Disabled because of occasional 'runaway' behavior, as browser registers a click-and-hold as a drag and drop  of the touchpad image, and so fails to register a mouse-up.
	$("#tp").mousedown(function(e){
		window.by -= 0.002*(e.pageX - Math.round(this.width/2) - this.x);
		window.bx -= 0.002*(e.pageY - Math.round(this.height/2) - this.y);
	}).mouseout(function(e){window.bx=0; window.by=0}).mouseup(function(e){window.bx=0; window.by=0});;
*/	
	$('.bpd').unbind();
	$('#b9').hide()
  	$('#b8').show().text("^").mousedown(function(e){// base forward 
		window.bx = 0.002*b_scale;
		}).mouseout(function(e){window.bx=0}).mouseup(function(e){window.bx=0});
		
	$('#b7').hide()
	$('#b6').show().text(">").mousedown(function(e){ //base right
   		window.by = -0.002*b_scale;
		}).mouseout(function(e){window.by=0}).mouseup(function(e){window.by=0});
	
	$('#b5').hide();
	$('#b4').show().text("<").mousedown(function(e){ //base left
   		window.by = 0.002*b_scale;
		}).mouseout(function(e){window.by=0}).mouseup(function(e){window.by=0});

  	$('#b3').show().text("Turn Right").mousedown(function(e){ //base rot right (cw)
   		window.bz = -0.006*b_scale;
		}).mouseout(function(e){window.bz=0}).mouseup(function(e){window.bz=0});

	$('#b2').show().text("v").mousedown(function(e){ // base backward
   		window.bx = -0.002*b_scale;
		}).mouseout(function(e){window.bx=0}).mouseup(function(e){window.bx=0});

   	$('#b1').show().text("Turn Left").mousedown(function(e){ //base rot left (ccw)
   		window.bz = 0.006*b_scale;
		}).mouseout(function(e){window.bz=0}).mouseup(function(e){window.bz=0});
};

function speak(text){
		node.publish('/text_to_say', 'std_msgs/String', json( { 'data':text } ));
		log('\"' + text +'\"'); 
};

function tuck_arms(arm){
        if (arm == 'r'){
            log('Sending Tuck Right Arm');
            node.publish('/wt_tuck_arms', 'std_msgs/String', json({'data':'right'}));
        } else if (arm == 'l') {
            log('Sending Tuck Left Arm');
            node.publish('/wt_tuck_arms', 'std_msgs/String', json({'data':'left'}));
        } else {
            log('Sending Tuck Both Arms')
            node.publish('/wt_tuck_arms', 'std_msgs/String', json({'data':'both'}));
        };
};

function halt_motors() {
	node.rosjs.callService('/pr2_etherCAT/halt_motors', json(''), nop);
};

function reset_motors() {
	node.rosjs.callService('/pr2_etherCAT/reset_motors', json(''), nop);
};

function set_camera(cam) {document.getElementById('video').src='http://'+robot+':8080/?topic=/' + cam + '?width=640?height=480'
};

function shave_step(x,y,z) {points = window.gm_point;
                        points.x = x; points.y = y; points.z = z;
                        node.publish('/wt_shave_step', 'geometry_msgs/Point', json(points));
                        log("Sending Adjustment to Shaving Position");
};

function send_shave_location(num) {node.publish('wt_shave_location', 'std_msgs/Int8', json({'data':num}));
                                   log("Sending New Shave Position: "+ document.getElementById('shave_list').options[window.sm_selected_pose].text);
};

function freeze_cloud() {node.publish('/reg_confirm', 'std_msgs/Bool', json({'data':true}))
                        log("Sending command to freeze head pointcloud")
};

function toggle_tool_power() {
    state = !window.tool_state;
    node.publish('/ros_switch', 'std_msgs/Bool', json({'data':state}));
    log("Sending Tool Power Toggle");
};

function start(){
    node = new ros.NodeHandle('ws://'+ robot + ':9091');
	node.setOnClose(function(e) {
          log("Disconnected or Can't Connect.");
    	});
    	node.setOnError(function(e) {
          log("Unknown error connecting!");
    	});
      	node.setOnOpen(function(e) {   
	  log("Connected to " + node.url + ".");
	  sub_state();
	  init();
	  });
};
</script>

<style>
.bpd{
text-align:center;
height:70px;
width:70px;} 
.cont_sel{
min-height:40px;
width:100%;}
.vid_sel{
min-height:30px;
width:100%
}
.act_menu{
text-align:center;
height:60px;
width:100px;
}
.shave_acts{
text-align:center;
height:60px;
width:100px;
}
</style>

</head>
  <body onload="start()">
<table>
  <tr>
    <td colspan='7'> <!-- Start Cell for video -->
      <div id='video_container' style="position:relative; height:480; width:640;">
        <div style="position:absolute; height:100%; width:100%; left:0; top:0;" onclick="image_click(event);"> </div>
        <iframe id='video' title="Video Stream from the PR2" style="height:100%; width:100%; left:0; top:0; border-style:none;">You Broswer does not support iFrames</iframe>
      </div>
    </td><!-- End Cell for video -->
    <td>
      <div> <!-- Start Force-Torque Set/Feedback Block -->
      <table border=1>
        <tr>
          <td colspan=2 align='center'>Force</td>
        </tr><tr>
        </tr><tr>
          <td colspan=2 align='center'> 0-20 N </td>
        </tr><tr>
          <td align='center'><div id='force_set' style="height:360px"></div></td>
          <td align='center'><div id='force_view' style="height:360px"></div></td>
        </tr><tr>
          <td align='center'> Set </td>
          <td align='center'> Felt </td>
        </tr>
      </table>
      </div> <!-- End Force-Torque Set/Feedback Block -->
    </td>
    <td>
      <table>
        <tr>
          <td>
            <button id="shave_start" class='act_menu' type="button" onclick="$('#bpd2, #head_nav_goal_flag, #shave_select, #shave_end, #tool_power').show(); $(this).hide(); $('#tp').hide();">Shave</button>
            <button id="shave_end" class='act_menu' type="button" onclick="$('#bpd2, #shave_select, #tool_power').hide(); $('#tp, #shave_start').show();$(this).hide()">End Shaving</button>
          </td>
       </tr>
       <tr><td><hr></td></tr>
       <tr>
         <td><button id="head_nav_goal_flag" class='shave_acts' type="button" onclick="window.img_act='head_nav_goal'; $('#init_head_flag').show(); $(this).hide()">Approach (Click Cheek)</button></td>
       </tr><tr>
        <td><button id="init_head_flag" class='shave_acts' type="button" onclick="window.img_act='init_head_cloud'; $('#freeze_cloud').show(); $(this).hide();">Initialize Head Model (Click Cheek)</button></td>
       </tr><tr>
         <td><button id="freeze_cloud" class='shave_acts' type="button" onclick="freeze_cloud(); $('#shave').show(); $(this).hide();">Freeze Pointcloud</button></td>
         </tr><tr>
         <td><button id="shave" class='shave_acts' type="button" onclick="send_shave_location(-1);">Shave Now</button></td>
        </tr>
      <tr>
        <td>
<div id='shave_select'>  <!--Shaving Selection Drop-Down and Entry -->
        <table id='shave_select'>
        <tr>
          <td>
            <select id='shave_list'>
              <option value=0>Neck</option>
              <option value=1>Chin</option>
              <option value=2>Jaw</option>
              <option value=3>Middle Cheek</option>
              <option value=4>Corner of Mouth</option>
              <option value=5>Near Ear</option>
              <option value=6>Nose</option>
              <option value=7>Upper Cheek</option>
	        </select>
          </td>
          </tr><tr>
          <td><button id="send_shave_select" type="button" onclick="window.sm_selected_pose = document.getElementById('shave_list').selectedIndex; log('Sending Command to move to ' + document.getElementById('shave_list').options[window.sm_selected_pose].text); send_shave_location(window.sm_selected_pose)">Shave Selection</button></td>
	    </tr>
	</table>
  </div>  <!--End Shaving Drop-Down -->
  </td></tr>
      <tr><td><button  class='shave_acts' id="tool_power" type="button" value="-1" onclick="toggle_tool_power()">Start/Stop Tool</button></td></tr>
      </td>
      </table>
    <td>
  <tr>
    <td> Camera: </td> <!-- Start Cell for Camera Selection -->
	  <td><select onchange="set_camera($(this).val());">
	      <!--<option value="/kinect_head/rgb/image_color">Kinect Camera</option>-->
	      <option value="/arrow_overlaid">Kinect Camera</option>
		  <option value="/wide_stereo/right/image_color">Wide Stereo Camera</option>
		  <option value="/l_forearm_cam/image_color_rotated">Left Forearm Camera</option>
		  <option value="/r_forearm_cam/image_color_rotated">Right Forearm Camera</option>
      </select></td> <!-- End Cell for Camera Selection -->
     
     <td>On Image Click:</td> <!-- Start Cell for Image Action Selection -->
     <td><select id='img_act_select' onchange="window.img_act=$(this).val()">
         <option id="looking" selected='selected' value='looking'>Look</option>
         <option id="na" value='norm_approach'>Normal Approach</option>
         <option id="touch" value='touch'>Touch</option>
         <!--<option id="wipe" value='wipe'>Wipe</option>-->
         <!--<option id="swipe" value='swipe'>Swipe</option>-->
         <!--<option id="poke" value='poke'>Poke</option>-->
         <!--<option id="surf_wipe" value='surf_wipe'>Surface Wipe</option>-->
         <!--<option id="grasp" value='grasp'>Grasp</option>-->
         <!--<option id="reactive_grasp" value='reactive_grasp'>Reactive Grasp</option>-->
         <!--<option id="contact_approach" value='contact_approach'>Approach until Contact</option>-->
         <!--<option id="hfc_contact_approach" value='hfc_contact_approach'>Approach until Contact HFC</option>
         <option id="hfc_swipe" value='hfc_swipe'>Swipe HFC</option>
         <option id="hfc_wipe" value='hfc_wipe'>Wipe HFC</option>-->
     </select></td> <!-- End Cell for Image Action Selection -->
     <td>Hand:</td> <!-- Start Cell for Hand Selection -->
     <td>
        <div id='arm_sel'>
          <input type='radio' id='l_arm' name='arm_sel' value='l' checked='checked'"/><label for='l_arm'>Left</label>
          <input type='radio' id='r_arm' name='arm_sel' value='r'/><label for='r_arm'">Right</label>
        </div>
      </td>
  </tr>
  <!--<tr>
     <td colspan=2><button id="l_arm_controller" type="button" value="l_arm_controller" onclick="node.publish('wt_cont_switch', 'std_msgs/String', json({'data':'l_arm_controller'}));"> Joint Angle Controller (Default) </button></td>
     <td colspan=2><button id="l_cart" type="button" value="l_cart" onclick="node.publish('wt_cont_switch', 'std_msgs/String', json({'data':'l_cart'}));"> Hybrid Force Controller </button></td>
  </tr>-->
    
</table>
<!-- ABANDONED BUTTONS: DRIVING AND ARM TUCKING -->

<div id="head_pos_out"></div>
<table><tr><td> <!-- Begin Gross Formatting-->
<div>
  <table>
    <tr><td colspan="2"><button class="cont_sel" id="cont_head" type="button" value="cont_head" onclick="teleop_head()">Control Head</button></td></tr>
    <tr>
       <td><button class="cont_sel" id="cont_l_arm" type="button" value="cont_l_arm" onclick="teleop_arm('l'); $('#l_arm').click()">Control Left Arm </button></td>
       <td><button class="cont_sel" id="cont_r_arm" type="button" value="cont_r_arm" onclick="teleop_arm('r'); $('#r_arm').click()">Control Right Arm </button></td>
    </tr>
    <tr>
       <td><button class="cont_sel" id="cont_l_hand" type="button" value="cont_l_hand" onclick="teleop_wrist('l')">Control Left Hand</button></td>
       <td><button class="cont_sel" id="cont_r_hand" type="button" value="cont_r_hand" onclick="teleop_wrist('r')">Control Right Hand </button></td>
    </tr>
    <tr><td colspan="2"><button class="cont_sel" id="cont_base" type="button" value="cont_base" onclick="teleop_base()">Control Base</button></td></tr>
    <tr>
    </tr>
 </table>
</div>
  <div id=speech_select>  <!--Speak Button and Text Input -->
        <table><tr>
          <form action=''>
             <td><button id="submit_text" type="button">Speak:</button></td>
             <td><input id="txt2say" type="text" style="height:auto;width:105%"/></td>
          </form>
        </tr>
	<tr>
	    <td>Phrases:</td>
	    <td><select onchange="speak($(this).val()); $('#txt2say').val($(this).val())">
		<option value="Yes">Yes</option>
		<option value="No">No</option>
		<option value="Maybe">Maybe</option>
		<option value="O K">Ok</option>
		<option value="k">k</option>
		<option value="Board Please">Board Please</option>
		<option value="I don\'t know">I Don't Know</option>
		<option value="I don\'t care">I Don't Care</option>
		<option value="One Moment">One Moment</option>
		<option value="Please">Please</option>
		<option value="ThankYou">Thank You</option>
		<option value="I agree">I agree</option>
		<option value="I disagree">I disagree</option>
		<option value="A lot">A lot</option>
		<option value="A little">A little</option>
		<option value="Hello">Hello</option>
		<option value="Goodbye">Goodbye</option>
	    </select></td>
	</tr>
	</table>
  </div>  <!--End Speak Button + Text -->

</td><td> <!-- Gross Formatting-->

<div id='bpd1'> <!--Buttonpad Controls-->
  <table>
    <tr><td rowspan="4">
      <div style="height:215px" id="slider"></div>
    </td></tr>
    <tr>
      <td><button class="bpd" id="b7" type="button" value=1> Down </button></td>
      <td><button class="bpd" id="b8" type="button" value=1> ^ </button></td>
      <td><button class="bpd" id="b9" type="button" value=1> Up </button></td>
    </tr>
    <tr>
      <td><button class="bpd" id="b4" type="button" value="1"><</button></td>
      <td><button class="bpd" id="b5" type="button" value=1> 0 </button></td>
      <td><button class="bpd" id="b6" type="button" value="-1">></button></td>
    </tr>
    <tr>
      <td><button class="bpd" id="b1" type="button" value="-1">Turn Left</button></td>
      <td><button class="bpd" id="b2" type="button" value="-1">v</button></td>
      <td><button class="bpd" id="b3" type="button" value="-1">Turn Right</button></td>
    </tr>
  </table>
</div> <!--END buttonpad controls -->
</td><td>
<div id='bpd2'> <!--Buttonpad Controls-->
  <table>
    <tr><td rowspan="4">
      <div style="height:215px" id="slider"></div>
    </td></tr>
    <tr>
      <td><button class="bpd" id="bpd2_b7" type="button" value=1 onclick="shave_step(0,0,-1)"> Ellipse In </button></td>
      <td><button class="bpd" id="bpd2_b8" type="button" value=1 onclick="shave_step(0,1,0)"> ^ </button></td>
      <td><button class="bpd" id="bpd2_b9" type="button" value=1 onclick="shave_step(0,0,1)"> Ellipse Out </button></td>
    </tr>
    <tr>
      <td><button class="bpd" id="bpd2_b4" type="button" value="1" onclick="shave_step(-1,0,0)"><</button></td>
      <td><button class="bpd" id="bpd2_b5" type="button" value=1 onclick="send_shave_location(window.sm_selected_pose)"> Current </button></td>
      <td><button class="bpd" id="bpd2_b6" type="button" value="-1" onclick="shave_step(1,0,0)">></button></td>
    </tr>
    <tr>
      <td><button class="bpd" id="bpd2_b1" type="button" value=1 onclick="send_shave_location(Math.max(window.sm_selected_pose -= 1, 0))"> Prev. </button></td>
      <td><button class="bpd" id="bpd2_b2" type="button" value="-1" onclick="shave_step(0,-1,0)">v</button></td>
      <td><button class="bpd" id="bpd2_b3" type="button" value=1 onclick="send_shave_location(window.sm_selected_pose += 1)"> Next </button></td>
    </tr>
  </table>
</div> <!--END buttonpad controls -->
</td><td>
     <img id="tp" src=touchpad.jpg title="Click here for 2D Control of the selected robot part" style="border-style:solid; border-width:3px height:201px; width:201px;">
</td>
<td> <!-- Gross Formatting-->
  <table border='1'>
    <th colspan='2'> Grippers </th><th>Torso</th>
    <tr><td>Left</td><td>Right</td><td>U/D</td></tr>
    <tr>
      <td rowspan="2" align='center'><div style="margin:5px;height:150px" id="lg_slider"></div></td>
      <td rowspan="2" align='center'><div style="margin:5px;height:150px" id="rg_slider"></div></td>
      <td><div style="margin: 5 auto; height:150px" id="torso_slider"></div></td>
    </tr>
  </table>
</tr>
<tr><td colspan='4'> <!-- Gross Formating-->
<div id="console"></div>
</td><td colspan='2'> <!-- Gross Formating-->
<tr><td colspan='4'>
  <button id="stop" type="button" style="color:red;background-color:gray;font:bold;height:auto;border-style:none;height:30px;width:100%;" onclick="halt_motors(); $(':button:not(#reset)').fadeTo(1,0.4); $('#reset').show(); log('YOU\'VE STOPPED THE ROBOT! Please click \'REACTIVATE\' to reset.')">STOP ROBOT! </button> 
  </td>
</tr><tr>
  <td colspan='4'>
    <button id="reset" type="button" style="color:white;background-color:green;font:bold;height:30px;width:100%" onclick="reset_motors(); $(':button').fadeTo(1,1); $(this).hide(); log('Operation Resumed.');">REACTIVATE</button>
 </td>
</tr></table> <!--END Gross Formating-->
</body>
</html>
