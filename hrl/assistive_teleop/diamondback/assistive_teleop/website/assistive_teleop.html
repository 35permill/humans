<html>
<head>
  <title>Assistive Teleoperation Interface</title>
    
    <link type="text/css" href="jqueryui/css/sunny/jquery-ui-1.8.10.custom.css" rel="stylesheet" />   
    <script type="text/javascript" src="jqueryui/js/jquery-1.4.4.min.js"></script> 
    <script type="text/javascript" src="jqueryui/js/jquery-ui-1.8.10.custom.min.js"></script> 
    <script type="text/javascript" src="json2.js"></script>
    <script type="text/javascript" src="rosbridge.min.js"></script>
    <script type="text/javascript" src="ros/ros.js"> </script>

<script type="text/javascript">
function nop(){};
function json(obj){return JSON.stringify(obj);};
function log(message){ document.getElementById('console').innerHTML = message.toString();  };

var robot = 'monty1.hsi.gatech.edu';
var camera_frame = 'head_plate_frame'
var frame_offset = 0.25;
var pub_part;
var h_scale=b_scale=rarm_scale=larm_scale=rwrist_scale=lwrist_scale=50;
var bx=by=bz=tz=rgp=lgp=0;
var rarm_joints = [];
var sel_from_cam = looking  = norm_appr_left = norm_appr_right = scratch = false;
var arm = 'r';
var plane = 'xy';
var following_hand = false;

$(function(){
	$('#slider').slider({value:50,min:0,max:100,step:1,orientation:'vertical'}); 
	$('#rg_slider').slider({min:0,max:0.09,step:0.001,orientation:'vertical'}); 
	$('#rg_slider').unbind("slidestop").bind("slidestop", function(event,ui){rgp=$('#rg_slider').slider("value"); pub_gripper('r',rgp); log('Opening/Closing Right Gripper'); });	
	$('#lg_slider').slider({min:0,max:0.09,step:0.001,orientation:'vertical'}); 
	$('#lg_slider').unbind("slidestop").bind("slidestop", function(event,ui){lgp=$('#lg_slider').slider("value"); pub_gripper('l',lgp); log("Opening/Closing Left Gripper"); });	
	$('#torso_slider').slider({min:0.005,max:0.3,step:0.01,orientation:'vertical'});
	$('#torso_slider').unbind("slidestop").bind("slidestop", function(event,ui){tz=$('#torso_slider').slider("value"); pub_spine(); log("Raising/Lowering Spine"); });	
	$('#submit_text').click(function(e){speak($('#txt2say').val())});
	$("body").find('*').mouseup(function(e){window.bx=0; window.by=0; window.bz=0});
	$('#slelect_plane').change(function(event,ui){window.plane = $('#select_plane').val()});
	$('.cont_sel').click(function(e){$('.cont_sel').css('background-color','buttonface'); $(this).css('background-color', 'gray') }); 
	$('#reset').hide(); 
});

function init (){
	if (!window.point_2d){
		node.rosjs.callService('/rosjs/reqClassFromTypeString','["pixel_2_3d/Pixel23d"]', function(msg){window.point_2d = msg; init()});
	}else if (!window.right_arm_goal){
		node.rosjs.callService('/rosjs/msgClassFromTypeString','["geometry_msgs/PoseStamped"]', function(msg){window.right_arm_goal= msg; window.left_arm_goal=msg; init()});
	}else if (!window.JTAGoal){
		node.rosjs.callService('/rosjs/msgClassFromTypeString','["pr2_controllers_msgs/JointTrajectoryActionGoal"]', function(msg){window.JTAGoal = msg; init()});
	}else {
	$('#video').attr('src','http://'+ robot + ':8080/?topic=/wide_stereo/right/image_rect_color?width=640?height=480');	
	log('Initialized');
	};
};

function sub_state() {
	node.subscribe('/head_traj_controller_state_throttle',function(msg){
			window.head = msg.desired;
			window.head_joints = msg.joint_names;
			document.getElementById('head_pos_out').innerHTML='Head Position: Left/Right:\ \ ' + Math.round(-window.head.positions[0]*180/Math.PI) + '\ deg.\ \ Up/Down:' + Math.round(-window.head.positions[1]*180/Math.PI) + '\ deg.'
			});

	node.subscribe('/r_gripper_controller_state_throttle',function(msg){rgp=msg.process_value;$('#rg_slider').show().slider("option", "value", rgp)});
	node.subscribe('/l_gripper_controller_state_throttle',function(msg){lgp=msg.process_value;$('#lg_slider').show().slider("option", "value", lgp)});
	node.subscribe('/torso_state_throttle',function(msg){tz=msg.actual.positions[0];$('#torso_slider').show().slider("option", "value", tz)});
	node.subscribe('/wt_log_out', function(msg){ log(msg.data.toString())});
	
		//Move Arm Pose State
	node.subscribe('/r_hand_pose_throttle', function(msg){ window.rarm_pose = msg});
	node.subscribe('/l_hand_pose_throttle', function(msg){ window.larm_pose = msg});
	node.subscribe('/r_arm_controller_state_throttle', function(msg){window.rarm_joints = msg.actual});
	node.subscribe('/l_arm_controller_state_throttle', function(msg){window.larm_joints = msg.actual});
};


function click_position(e) {
	var posx = 0;
	var posy = 0;
	if (!e) var e = window.event;
	if (e.pageX || e.pageY) 	{
		posx = e.pageX;
		posy = e.pageY;
	}
	else if (e.clientX || e.clientY) 	{
		posx = e.clientX + document.body.scrollLeft
			+ document.documentElement.scrollLeft;
		posy = e.clientY + document.body.scrollTop
			+ document.documentElement.scrollTop;
	}	return [posx,posy]
}

function get_im_3d(x,y){
	window.point_2d.pixel_u = x;
	window.point_2d.pixel_v = y;
	node.rosjs.callService('/pixel_2_3d','['+JSON.stringify(window.point_2d.pixel_u)+','+JSON.stringify(window.point_2d.pixel_v)+']', function(msg){
		log('pixel_2_3d response');
		point_3d=msg;
		if (scratch){
			node.publish('wt_pixel3d', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d.pixel3d));
            log('Scratching');
		} else if(norm_appr_right){
			node.publish('norm_approach_right', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d.pixel3d));
			log('Attempting Normal Approach with Right Arm')
		} else if(norm_appr_left){
			node.publish('norm_approach_left', 'geometry_msgs/PoseStamped', JSON.stringify(point_3d.pixel3d));
			log('Attempting Normal Approach with Left Arm')
		} else {
            if (window.following_hand){
			    window.pub_part = window.clearInterval(pub_part);
            }
			pub_head_goal(point_3d.pixel3d.pose.position.x, point_3d.pixel3d.pose.position.y, point_3d.pixel3d.pose.position.z, point_3d.pixel3d.header.frame_id);
		};
		looking=false;
		norm_appr_left = false;
		norm_appr_right = false;
		scratch = false;
	});
};

function get_point(event){
	var point = click_position(event);
	click_x = point[0] - document.getElementById('video_container').offsetLeft 
	click_y = point[1] - document.getElementById('video_container').offsetTop 

	log("Clicked on point (x,y) = ("+ click_x.toString() +","+ click_y.toString()+")");
	return [click_x, click_y]
};
function image_click(event){
	var im_pixel = get_point(event);
	
	if (sel_from_cam) {
	window.srv_form.image_click.header.frame_id = '/wide_stereo_frame'  
	window.srv_form.image_click.point.x= click_x;  
	window.srv_form.image_click.point.y= click_y;  
        node.rosjs.callService('/clickable_world/click_image','['+JSON.stringify(window.srv_form.image_click)+']', nop);
	sel_from_cam = false;
	}else{
	get_im_3d(im_pixel[0],im_pixel[1])
	};
};

function pub_lin_move(arm){
	if (arm == 'r'){
		node.publish('wt_lin_move_right','std_msgs/Float32', JSON.stringify({"data":window.lin_move_right}));
		log('Right Hand: Advance/Retreat');
	} else {
		node.publish('wt_lin_move_left','std_msgs/Float32', JSON.stringify({"data":window.lin_move_left}));
		log('Left Hand: Advance/Retreat');
	};
};

function pub_arm_joints(angles, arm){
	angles.velocities = [];
	if (arm == 'r'){
		node.publish('wt_right_arm_angle_commands', 'trajectory_msgs/JointTrajectoryPoint', JSON.stringify(rarm_joints))
	}else{
		node.publish('wt_left_arm_angle_commands', 'trajectory_msgs/JointTrajectoryPoint', JSON.stringify(larm_joints))
	}	
};

function control_arm(x,y,z,arm){
	if (arm == 'r'){
		log('Commanding right arm');
		right_arm_goal = rarm_pose;
		right_arm_goal.pose.position.x += x;
		right_arm_goal.pose.position.y += y;
		right_arm_goal.pose.position.z += z;
		node.publish('wt_right_arm_pose_commands', 'geometry_msgs/PoseStamped', JSON.stringify(right_arm_goal));
	}else{
		log('Commanding left arm');
		left_arm_goal = larm_pose;
		left_arm_goal.pose.position.x += x;
		left_arm_goal.pose.position.y += y;
		left_arm_goal.pose.position.z += z;
		node.publish('wt_left_arm_pose_commands', 'geometry_msgs/PoseStamped', JSON.stringify(left_arm_goal));
	};
};

function pub_head_traj(head_traj_goal)  {
		if (head_traj_goal.goal.trajectory.points[0].positions[0] < -2.70) {head_traj_goal.goal.trajectory.points[0].positions[0] = -2.70} 
		if (head_traj_goal.goal.trajectory.points[0].positions[0] > 2.70) {head_traj_goal.goal.trajectory.points[0].positions[0] = 2.70}
		if (head_traj_goal.goal.trajectory.points[0].positions[1] < -0.5) {head_traj_goal.goal.trajectory.points[0].positions[1] = -0.5}
		if (head_traj_goal.goal.trajectory.points[0].positions[1] > 1.4) {head_traj_goal.goal.trajectory.points[0].positions[1] = 1.4}
		head_traj_goal.goal.trajectory.joint_names = window.head_joints;
		head_traj_goal.goal.trajectory.points[0].time_from_start.secs = 1;
    		node.publish('head_traj_controller/joint_trajectory_action/goal', 'pr2_controllers_msgs/JointTrajectoryActionGoal', JSON.stringify(head_traj_goal));
};

function pub_head_goal(x,y,z,frame) {
	node.publish('head_traj_controller/point_head_action/goal', 'pr2_controllers_msgs/PointHeadActionGoal', json(
		{  'goal':{'target':{'header':{'frame_id':frame },
				     'point':{'x':x, 'y':y, 'z':z-window.frame_offset}},
			   'pointing_axis':{'x':1, 'pointing_frame':window.camera_frame},
			   'max_velocity':0.6}}))
	//log("Looking at "+x.toString() +", "+y.toString()+", "+z.toString()+" in "+frame);
};

function pub_gripper(arm,grpos) {
	node.publish(arm + '_gripper_controller/gripper_action/goal', 'pr2_controllers_msgs/Pr2GripperCommandActionGoal', JSON.stringify(
		{    'goal':{'command':{'position': grpos ,'max_effort':-1}}}));
};

function teleop_arm(arm) {
	var x,y,z,b9txt,b7txt;
	if (plane == 'xy'){x=0; y=1; z=2; b9txt='Up'; b7txt='Down'}
	else if (plane == 'yz') {x=2; y=1; z=0; b9txt='Further Away'; b7txt='Closer'};

	if (arm=='r') {	
		log("Controlling Right Arm");
		$('#slider').unbind("slidestop");
		$('#slider').bind("slidestop", function(event,ui){rarm_scale = $('#slider').slider("value")});
		$('#slider').show().slider("option", "value", rarm_scale);

		$("#tp").unbind().show();
		$("#tp").click(function(e){
			y = -(e.pageX - Math.round(this.width/2) - this.x)/500;
			x = -(e.pageY - Math.round(this.height/2) - this.y)/500;
			control_arm(x,y,0,'r');	
		});

		$('.bpd').unbind();
		$('#b9').show().text(b9txt).click(function(e){//arm up vertically
			control_arm(0,0,rarm_scale/500,'r');
		});
		$('#b8').show().text("^").click(function(e){//arm forward horizantally 
			control_arm(rarm_scale/500,0,0,'r');
		});
		$('#b7').show().text(b7txt).click(function(e){//arm down vertically
			control_arm(0,0,-rarm_scale/500,'r');
		});
		$('#b6').show().text(">").click(function(e){ // arm right horizantally 
			control_arm(0,-rarm_scale/500,0,'r');
		});
		$('#b5').show().text("Normal Approach").click(function(e){window.norm_appr_right=true; document.getElementById('video').src='http://'+robot+':8080/?topic=/arrow_overlaid?width=640?height=480'});
		$('#b4').show().text("<").click(function(e){ //arm left horizantally
			control_arm(0,rarm_scale/500,0,'r');
		});
		$('#b3').show().text("Advance").click(function(e){window.lin_move_right=0.05*(rarm_scale/100); pub_lin_move('r');});
		$('#b2').show().text("v").click(function(e){ //arm backward horizantally
			control_arm(-rarm_scale/500,0,0,'r');
		});
		$('#b1').show().text("Retreat").click(function(e){window.lin_move_right=-0.05*(rarm_scale/100); pub_lin_move('r');});
	} else {
		log("Controlling Left Arm");
		$('#slider').unbind("slidestop");
		$('#slider').bind("slidestop", function(event,ui){larm_scale = $('#slider').slider("value")});
		$('#slider').show().slider("option", "value", larm_scale);
		
		$("#tp").unbind().show();
		$("#tp").click(function(e){
			y = -(e.pageX - Math.round(this.width/2) - this.x)/500;
			x = -(e.pageY - Math.round(this.height/2) - this.y)/500;
			control_arm(x,y,0,'l');	
		});

		$('.bpd').unbind();
		$('#b9').show().text("Up").click(function(e){//arm up vertically
			control_arm(0,0,larm_scale/500,'l');
		});
		$('#b8').show().text("^").click(function(e){//arm forward horizantally 
			control_arm(larm_scale/500,0,0,'l');
		});
		$('#b7').show().text("Down").click(function(e){//arm down vertically
			control_arm(0,0,-larm_scale/500,'l');
		});
		$('#b6').show().text(">").click(function(e){ // arm right horizantally 
			control_arm(0,-larm_scale/500,0,'l');
		});
		$('#b5').show().text("Normal Approach").click(function(e){window.norm_appr_left=true; document.getElementById('video').src='http://'+robot+':8080/?topic=/arrow_overlaid?width=640?height=480'});
		$('#b4').show().text("<").click(function(e){ //arm left horizantally
			control_arm(0,larm_scale/500,0,'l');
		});
		$('#b3').show().text("Advance").click(function(e){window.lin_move_left=0.05*(larm_scale/100); pub_lin_move('l');});
		$('#b2').show().text("v").click(function(e){ //arm backward horizantally
			control_arm(-larm_scale/500,0,0,'l');
		});
		$('#b1').show().text("Retreat").click(function(e){window.lin_move_left=-0.05*(larm_scale/100); pub_lin_move('l');});
	};
};

function teleop_wrist(arm) {
	if (arm=='r') {	
		log("Controlling Right Hand");
		$('#slider').unbind("slidestop");
		$('#slider').bind("slidestop", function(event,ui){rwrist_scale = $('#slider').slider("value")});
		$('#slider').show().slider("option", "value", rwrist_scale);
		$('.bpd').unbind();
	
		$("#tp").unbind().show();
		$("#tp").click(function(e){
			x = (e.pageX - Math.round(this.width/2) - this.x);
			y = (e.pageY - Math.round(this.height/2) - this.y);
			rarm_joint_goals = rarm_joints;
			rarm_joint_goals.positions[4] += x*0.0107;
			rarm_joint_goals.positions[5] -= y*(Math.PI/200);
			pub_arm_joints(rarm_joint_goals,'r')
		});

		$('#b9').show().text("Hand Roll Right").click(function(e){
			rarm_joint_goals = rarm_joints;
			rarm_joint_goals.positions[6] += rwrist_scale*(Math.PI/200);
			pub_arm_joints(rarm_joint_goals,'r')
		});
		$('#b8').show().text("Wrist Flex Out").click(function(e){
			rarm_joint_goals = rarm_joints;
			rarm_joint_goals.positions[5] += rwrist_scale*0.0107;
			pub_arm_joints(rarm_joint_goals,'r')
		});
		$('#b7').show().text("Hand Roll Left").click(function(e){
			rarm_joint_goals = rarm_joints;
			rarm_joint_goals.positions[6] -= rwrist_scale*(Math.PI/200);
			pub_arm_joints(rarm_joint_goals,'r')
		});
		$('#b6').show().text("Arm Roll Right").click(function(e){
			rarm_joint_goals = rarm_joints;
			rarm_joint_goals.positions[4] += rwrist_scale*(Math.PI/200);
			pub_arm_joints(rarm_joint_goals,'r')
		});
		$('#b5').hide()
		$('#b4').show().text("Arm Roll Left").click(function(e){
			rarm_joint_goals = rarm_joints;
			rarm_joint_goals.positions[4] -= rwrist_scale*0.0107;
			pub_arm_joints(rarm_joint_goals,'r')
		});
		$('#b3').hide()
		$('#b2').show().text("Wrist Flex In").click(function(e){ 
			rarm_joint_goals = rarm_joints;
			rarm_joint_goals.positions[5] -= rwrist_scale*(Math.PI/200);
			pub_arm_joints(rarm_joint_goals,'r')
		});
		$('#b1').hide();

		
	} else {
		log("Controlling Left Hand");
		$('#slider').unbind("slidestop");
		$('#slider').bind("slidestop", function(event,ui){lwrist_scale = $('#slider').slider("value")});
		$('#slider').show().slider("option", "value", lwrist_scale);
		$('.bpd').unbind();

		$("#tp").unbind().show();
		$("#tp").click(function(e){
			x = (e.pageX - Math.round(this.width/2) - this.x);
			y = (e.pageY - Math.round(this.height/2) - this.y);
			larm_joint_goals = larm_joints;
			larm_joint_goals.positions[4] += x*0.0107;
			larm_joint_goals.positions[5] -= y*(Math.PI/200);
			pub_arm_joints(larm_joint_goals,'l')
		});

		$('#b9').show().text("Hand Roll Right").click(function(e){
			larm_joint_goals = larm_joints;
			larm_joint_goals.positions[6] += lwrist_scale*(Math.PI/200);
			pub_arm_joints(larm_joint_goals,'l')
		});
		$('#b8').show().text("Wrist Flex Out").click(function(e){
			larm_joint_goals = larm_joints;
			larm_joint_goals.positions[5] += lwrist_scale*0.0107;
			pub_arm_joints(larm_joint_goals,'l')
		});
		$('#b7').show().text("Hand Roll Left").click(function(e){
			larm_joint_goals = larm_joints;
			larm_joint_goals.positions[6] -= lwrist_scale*(Math.PI/200);
			pub_arm_joints(larm_joint_goals,'l')
		});
		$('#b6').show().text("Arm Roll Right").click(function(e){
			larm_joint_goals = larm_joints;
			larm_joint_goals.positions[4] += lwrist_scale*(Math.PI/200);
			pub_arm_joints(larm_joint_goals,'l')
		});
		$('#b5').hide();
		$('#b4').show().text("Arm Roll Left").click(function(e){
			larm_joint_goals = larm_joints;
			larm_joint_goals.positions[4] -= lwrist_scale*(Math.PI/200);
			pub_arm_joints(larm_joint_goals,'l')
		});
		$('#b3').hide();
		$('#b2').show().text("Wrist Flex In").click(function(e){ //
			larm_joint_goals = larm_joints;
			larm_joint_goals.positions[5] -= lwrist_scale*0.0107;
			pub_arm_joints(larm_joint_goals,'l')
		});
		$('#b1').hide();
	};
};

function pub_spine(tz) {
	node.publish('torso_controller/position_joint_action/goal','pr2_controllers_msgs/SingleJointPositionActionGoal',json(
		{'goal':{'position': this.tz }}))
};

function teleop_head() {
	//window.pub_part = window.clearInterval(pub_part);
	log('Controlling Head');
	$('#slider').unbind("slidestop");
	$('#slider').bind("slidestop", function(event,ui){h_scale = $('#slider').slider("value")});
	$('#slider').show().slider("option", "value", h_scale);
	
	$("#tp").unbind().show();
	$("#tp").click(function(e){
		window.pub_part = window.clearInterval(pub_part);
        window.following_hand = false;
		x = (e.pageX - Math.round(this.width/2) - this.x)/200;
		y = (e.pageY - Math.round(this.height/2) - this.y)/200;
   		head_traj_goal = JTAGoal;
		head_traj_goal.goal.trajectory.points[0] = window.head;
		head_traj_goal.goal.trajectory.points[0].positions[0] -= x;
		head_traj_goal.goal.trajectory.points[0].positions[1] += y;
                pub_head_traj(head_traj_goal);
	});
	
	$('.bpd').unbind();
	$('#b9').hide(); 
	$('#b8').show().text("^").click(function(e){//head up 
		window.pub_part = window.clearInterval(pub_part);
        window.following_hand = false;
   		head_traj_goal = JTAGoal;
		head_traj_goal.goal.trajectory.points[0] = window.head;
		head_traj_goal.goal.trajectory.points[0].positions[1] -= h_scale/150;
                pub_head_traj(head_traj_goal);
	});
	$('#b7').hide();
	$('#b6').show().text(">").click(function(e){ //head right
		window.pub_part = window.clearInterval(pub_part);
        window.following_hand = false;
   		head_traj_goal = JTAGoal;
		head_traj_goal.goal.trajectory.points[0] = window.head;
		head_traj_goal.goal.trajectory.points[0].positions[0] -= h_scale/150;
                pub_head_traj(head_traj_goal);
	});
	$('#b5').show().text("o").click(function(e){ //center head to (0,0)
		window.pub_part = window.clearInterval(pub_part);
        window.following_hand = false;
   		head_traj_goal = JTAGoal;
		head_traj_goal.goal.trajectory.points[0] = window.head;
		head_traj_goal.goal.trajectory.points[0].positions = [0,0];
                pub_head_traj(head_traj_goal);
	});
	$('#b4').show().text("<").click(function(e){ //head left
		window.pub_part = window.clearInterval(pub_part);
        window.following_hand = false;
   		head_traj_goal = JTAGoal;
		head_traj_goal.goal.trajectory.points[0] = window.head;
		head_traj_goal.goal.trajectory.points[0].positions[0] += h_scale/150;
                pub_head_traj(head_traj_goal);
	});
	$('#b3').show().text("Track Right Hand").click(function(e){
		window.pub_part = window.clearInterval(pub_part);
        window.following_hand = true;
		window.pub_part = window.setInterval("pub_head_goal(0,0,window.frame_offset,'r_gripper_tool_frame');",200);
	});	
  	$('#b2').show().text("v").click(function(e){ //head down
		window.pub_part = window.clearInterval(pub_part);
        window.following_hand = false;
   		head_traj_goal = JTAGoal;
		head_traj_goal.goal.trajectory.points[0] = window.head;
		head_traj_goal.goal.trajectory.points[0].positions[1] += h_scale/150;
                pub_head_traj(head_traj_goal);
	});
	$('#b1').show().text("Track Left Hand").click(function(e){
		window.pub_part = window.clearInterval(pub_part);
        window.following_hand = true;
		window.pub_part = window.setInterval("pub_head_goal(0,0,window.frame_offset,'l_gripper_tool_frame');",200);
	});
};

function pub_Twist(bx,by,bz) {
          node.publish('/base_controller/command', 'geometry_msgs/Twist', '{"linear":{"x":' + bx + ',"y":' + by + ',"z":0}, "angular":{"x":0,"y":0,"z":' + bz + '}}');
};

function teleop_base() {
	window.pub_part = window.clearInterval(pub_part);
    window.following_hand = false;
	window.pub_part = setInterval("pub_Twist(window.bx,window.by,window.bz)", 25);
	log("Controlling Base");
	$('#slider').unbind("slidestop");
	$('#slider').bind("slidestop", function(event,ui){b_scale = $('#slider').slider("value")});
	$('#slider').show().slider("option", "value", b_scale);
	
	$("#tp").unbind().hide();
/*// Control Mappings for the touchpad for moving the base: Disabled because of occasional 'runaway' behavior, as browser registers a click-and-hold as a drag and drop  of the touchpad image, and so fails to register a mouse-up.
	$("#tp").mousedown(function(e){
		window.by -= 0.002*(e.pageX - Math.round(this.width/2) - this.x);
		window.bx -= 0.002*(e.pageY - Math.round(this.height/2) - this.y);
	}).mouseout(function(e){window.bx=0; window.by=0}).mouseup(function(e){window.bx=0; window.by=0});;
*/	
	$('.bpd').unbind();
	$('#b9').hide()
  	$('#b8').show().text("^").mousedown(function(e){// base forward 
		window.bx = 0.002*b_scale;
		}).mouseout(function(e){window.bx=0}).mouseup(function(e){window.bx=0});
		
	$('#b7').hide()
	$('#b6').show().text(">").mousedown(function(e){ //base right
   		window.by = -0.002*b_scale;
		}).mouseout(function(e){window.by=0}).mouseup(function(e){window.by=0});
	
	$('#b5').hide();
	$('#b4').show().text("<").mousedown(function(e){ //base left
   		window.by = 0.002*b_scale;
		}).mouseout(function(e){window.by=0}).mouseup(function(e){window.by=0});

  	$('#b3').show().text("Turn Right").mousedown(function(e){ //base rot right (cw)
   		window.bz = -0.006*b_scale;
		}).mouseout(function(e){window.bz=0}).mouseup(function(e){window.bz=0});

	$('#b2').show().text("v").mousedown(function(e){ // base backward
   		window.bx = -0.002*b_scale;
		}).mouseout(function(e){window.bx=0}).mouseup(function(e){window.bx=0});

   	$('#b1').show().text("Turn Left").mousedown(function(e){ //base rot left (ccw)
   		window.bz = 0.006*b_scale;
		}).mouseout(function(e){window.bz=0}).mouseup(function(e){window.bz=0});
};

function speak(text){
		node.publish('/text_to_say', 'std_msgs/String', json( { 'data':text } ));
		log('\"' + text +'\"'); 
		};

function halt_motors() {
	node.rosjs.callService('/pr2_etherCAT/halt_motors', json(''), nop);
};

function reset_motors() {
	node.rosjs.callService('/pr2_etherCAT/reset_motors', json(''), nop);
};

function start(){
    node = new ros.NodeHandle('ws://'+ robot + ':9091');
	node.setOnClose(function(e) {
          log("Disconnected or Can't Connect.");
    	});
    	node.setOnError(function(e) {
          log("Unknown error!");
    	});
      	node.setOnOpen(function(e) {   
	  log("Connected to " + node.url + ".");
	  sub_state();
	  init();
	  });
};
</script>

<style>
.bpd{
text-align:center;
height:70px;
width:70px;} 
.cont_sel{
min-height:40px;
width:100%;}
.vid_sel{
min-height:30px;
width:100%
}
</style>

</head>
  <body onload="start()">
<table>
  <tr>
    <td colspan='4'>
      <div id='video_container' style="position:relative; height:480; width:640;">
        <div style="position:absolute; height:100%; width:100%; left:0; top:0;" onclick="image_click(event);"> </div>
        <iframe id='video' title="Video Stream from the PR2" style="height:100%; width:100%; left:0; top:0; border-style:none;">You Broswer does not support iFrames</iframe>
      </div>
    </tr>
  <tr>
    <td><button class="vid_sel" id="l_arm_cam" type="button" value="l_forearm_cam" title="Left Forearm Camera" onclick="document.getElementById('video').src='http://'+robot+':8080/?topic=/l_forearm_cam/image_color_rotated?width=640?height=480?quality=50'">Left Arm Cam</button></td>
    <td><button class="vid_sel" id="head_cam" type="button" value="wide_stereo/right" title="Head Wideview Camera" onclick="window.camera_frame='wide_stereo_r_stereo_camera_frame'; document.getElementById('video').src='http://'+robot+':8080/?topic=/wide_stereo/right/image_rect_color?width=640?height=480'"> Head Camera </button></td>
    <td><button class="vid_sel" id="kinect_head_cam" type="button" value="wide_stereo/right" title="Kinect Camera View" onclick="window.camera_frame='/openni_rgb_frame'; document.getElementById('video').src='http://'+robot+':8080/?topic=/kinect_head/rgb/image_color?width=640?height=480'">Kinect Camera</button></td>
    <td><button class="vid_sel" id="r_arm_cam" type="button" value="r_forearm_cam" title="Right Forearm Camera" onclick="document.getElementById('video').src='http://'+robot+':8080/?topic=/r_forearm_cam/image_color_rotated?width=640?height=480'">Right Arm Cam</button></td> 
 </tr>
</table>

<div id="head_pos_out"></div>

<table><tr><td> <!-- Begin Gross Formatting-->
<div>
  <table>
    <tr><td colspan="2"><button class="cont_sel" id="cont_head" type="button" value="cont_head" onclick="teleop_head()">Control Head</button></td></tr>
    <tr>
       <td><button class="cont_sel" id="cont_l_arm" type="button" value="cont_l_arm" onclick="teleop_arm('l'); window.arm='l'">Control Left Arm </button></td>
       <td><button class="cont_sel" id="cont_r_arm" type="button" value="cont_r_arm" onclick="teleop_arm('r'); window.arm='r'">Control Right Arm </button></td>
    </tr>
    <tr>
       <td><button class="cont_sel" id="cont_l_hand" type="button" value="cont_l_hand" onclick="teleop_wrist('l')">Control Left Hand</button></td>
       <td><button class="cont_sel" id="cont_r_hand" type="button" value="cont_r_hand" onclick="teleop_wrist('r')">Control Right Hand </button></td>
    </tr>
    <tr><td colspan="2"><button class="cont_sel" id="cont_base" type="button" value="cont_base" onclick="teleop_base()">Control Base</button></td></tr>
 </table>
</div>
 <!--Speak Button and Text Input -->
        <table><tr>
          <form action=''>
             <td><button id="submit_text" type="button">Speak:</button></td>
             <td><input id="txt2say" type="text" style="height:auto;width:105%"/></td>
          </form>
        </tr>
	<tr>
	    <td>Phrases:</td>
	    <td><select onchange="speak($(this).val()); $('#txt2say').val($(this).val())">
		<option value="Yes">Yes</option>
		<option value="No">No</option>
		<option value="Maybe">Maybe</option>
		<option value="O K">Ok</option>
		<option value="k">k</option>
		<option value="Board Please">Board Please</option>
		<option value="I don\'t know">I Don't Know</option>
		<option value="I don\'t care">I Don't Care</option>
		<option value="One Moment">One Moment</option>
		<option value="Please">Please</option>
		<option value="ThankYou">Thank You</option>
		<option value="I agree">I agree</option>
		<option value="I disagree">I disagree</option>
		<option value="A lot">A lot</option>
		<option value="A little">A little</option>
		<option value="Hello">Hello</option>
		<option value="Goodbye">Goodbye</option>
	    </select></td>
	</tr>
	</table>
  <!--End Speak Button + Text -->

</td><td> <!-- Gross Formatting-->

<div> <!--Buttonpad Controls-->
  <table>
    <tr><td rowspan="4">
      <div style="height:215px" id="slider"></div>
    </td></tr>
    <tr>
      <td><button class="bpd" id="b7" type="button" value=1> Down </button></td>
      <td><button class="bpd" id="b8" type="button" value=1> ^ </button></td>
      <td><button class="bpd" id="b9" type="button" value=1> Up </button></td>
    </tr>
    <tr>
      <td><button class="bpd" id="b4" type="button" value="1"><</button></td>
      <td><button class="bpd" id="b5" type="button" value=1> o </button></td>
      <td><button class="bpd" id="b6" type="button" value="-1">></button></td>
    </tr>
    <tr>
      <td><button class="bpd" id="b1" type="button" value="-1">Turn Left</button></td>
      <td><button class="bpd" id="b2" type="button" value="-1">v</button></td>
      <td><button class="bpd" id="b3" type="button" value="-1">Turn Right</button></td>
    </tr>
  </table>
</div> <!--END buttonpad controls -->
</td><td>
     <img id="tp" src=touchpad.jpg title="Click here for 2D Control of the selected robot part" style="border-style:solid; border-width:3px height:201px; width:201px;">
</td>
<td> <!-- Gross Formatting-->
  <table border='1'>
    <th colspan='2'> Grippers </th><th>Torso</th>
    <tr><td>Left</td><td>Right</td><td>U/D</td></tr>
    <tr>
      <td rowspan="2" align='center'><div style="margin:5px;height:150px" id="lg_slider"></div></td>
      <td rowspan="2" align='center'><div style="margin:5px;height:150px" id="rg_slider"></div></td>
      <td><div style="margin: 5 auto; height:150px" id="torso_slider"></div></td>
    </tr>
  </table>
</tr>
<tr><td colspan='4'> <!-- Gross Formating-->
<div id="console"></div>
</td><td colspan='2'> <!-- Gross Formating-->
<tr><td colspan='4'>
  <button id="stop" type="button" style="color:red;background-color:gray;font:bold;height:auto;border-style:none;height:30px;width:100%;" onclick="halt_motors(); $(':button:not(#reset)').fadeTo(1,0.4); $('#reset').show(); log('YOU\'VE STOPPED THE ROBOT! Please click \'REACTIVATE\' to reset.')">STOP ROBOT! </button> 
  </td>
</tr><tr>
  <td colspan='4'>
    <button id="reset" type="button" style="color:white;background-color:green;font:bold;height:30px;width:100%" onclick="reset_motors(); $(':button').fadeTo(1,1); $(this).hide(); log('Operation Resumed.');">REACTIVATE</button>
 </td>
</tr></table> <!--END Gross Formating-->
</body>
</html>
